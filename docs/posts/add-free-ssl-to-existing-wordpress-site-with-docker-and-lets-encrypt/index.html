<!DOCTYPE html>
<html lang="en-gb">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Asep Bagja Priandana">
    <meta name="description" content="My personal blog">
    <meta name="keywords" content="blog,developer,personal">

    <base href="https://bepitulaz.github.io/">
    <title>
  Add Free SSL to Existing WordPress Site with Docker and Let&#39;s Encrypt · Asep&#39;s Notes
</title>

    <link rel="canonical" href="https://bepitulaz.github.io/posts/add-free-ssl-to-existing-wordpress-site-with-docker-and-lets-encrypt/">

    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="https://bepitulaz.github.io/css/style.min.css">

    <link rel="icon" type="image/png" href="https://bepitulaz.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://bepitulaz.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.37" />
  </head>

  <body>
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://bepitulaz.github.io/">
      Asep&#39;s Notes
    </a>
    
    <ul class="navigation-list float-right">
      
      <li class="navigation-item">
        <a class="navigation-link" href="https://bepitulaz.github.io/posts/">Blog</a>
      </li>
      
      <li class="navigation-item">
        <a class="navigation-link" href="https://bepitulaz.github.io/about/">About</a>
      </li>
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">Add Free SSL to Existing WordPress Site with Docker and Let&#39;s Encrypt</h1>
      <h2 class="date">June 24, 2016</h2>
    </header>

    <p>Google announced that they use HTTPS as a ranking signal <a href="https://webmasters.googleblog.com/2014/08/https-as-ranking-signal.html">on 2014</a>, and it becomes more standard in their search result. Therefore, I decide to use HTTPS also for this blog; and it looks pretty too for having a green lock icon on the browser. I&rsquo;m a Docker devotee, so I&rsquo;ll show you how to do it by using Docker.</p>

<p><strong>1. Install Docker on the server</strong></p>

<p>I&rsquo;m using Ubuntu 16.04 on my <a href="https://m.do.co/c/603d8d4e7ded">Digital Ocean</a> droplet. So, you can follow Docker official installation guide for Ubuntu on their documentation page <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">here</a>.</p>

<p><strong>2. Run Let&rsquo;s Encrypt companion for Nginx proxy container</strong></p>

<p>Before running this container, I will shortly explain what Let&rsquo;s Encrypt is, in case you never heard it. Taken from its website, it is a free, automated, and open certificate authority (CA), run for the public&rsquo;s benefit. Let&rsquo;s Encrypt is a service provided by the <a href="https://letsencrypt.org/isrg/">Internet Security Research Group (ISRG)</a>. Hence, we don&rsquo;t need to buy and manually renew the SSL certificate anymore.</p>

<p>I assume you are at the home folder (/home/user/). You should create a directory for storing the certificates.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ mkdir certs</pre></div>
<p>Then, you will run Nginx as the proxy server for our WordPress container. I&rsquo;m using Nginx proxy image which is maintained by <a href="https://github.com/jwilder/nginx-proxy">jwilder</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker run -d -p 80:80 -p 443:443 \
  --name nginx-proxy \
  -v /home/user/certs:/etc/nginx/certs:ro \
  -v /etc/nginx/vhost.d \
  -v /usr/share/nginx/html \
  -v /var/run/docker.sock:/tmp/docker.sock:ro \
  jwilder/nginx-proxy</pre></div>
<p>If you look the command above, 3 writable volumes are declared:</p>

<ul>
<li><code>/etc/nginx/certs</code> is for creating and renewing Let&rsquo;s Encrypt certificates</li>
<li><code>/etc/nginx/vhost.d</code> is for changing the configuration of vhosts, and it&rsquo;s needed by Let&rsquo;s Encrypt</li>
<li><code>/usr/share/nginx/html</code> is for writing challenge files, so Let&rsquo;s Encrypt can verify your domain.</li>
</ul>

<p>After the Nginx proxy container is running, you will run Let&rsquo;s Encrypt container to create and renew the certificate for each domain that you want to add the SSL certificate. I will use the Let&rsquo;s Encrypt image which is maintained by <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion">JrCs</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker run -d \
  -v /home/user/certs:/etc/nginx/certs:rw \
  --volumes-from nginx-proxy \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  jrcs/letsencrypt-nginx-proxy-companion</pre></div>
<p>Ensure those 2 containers are running by using <code>docker ps</code> command. Then you can start any containers to be proxified with https connection by using this command:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker run -e &#34;VIRTUAL_HOST=yourdomain.com&#34; \
  -e &#34;LETSENCRYPT_HOST=yourdomain.com,www.yourdomain.com&#34; \
  -e &#34;LETSENCRYPT_EMAIL=your@youremail.com&#34; \
  ... # put the rest of the necessary settings here </pre></div>
<p>The <code>LETSENCRYPT_HOST</code> and <code>LETSENCRYPT_EMAIL</code> are necessary, so Let&rsquo;s Encrypt service can automatically create and renew valid certificate for each virtual host.</p>

<p><strong>3. Install MySQL database</strong></p>

<p>I&rsquo;m using <a href="https://hub.docker.com/_/mysql/">MySQL official image</a>. I&rsquo;m storing the MySQL data in host directory to prevent data loss when the container restart or die.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ mkdir data

/home/user/:$ docker run --name wp_mysql \
  -v /home/user/data:/var/lib/mysql \
  -e MYSQL_ROOT_PASSWORD=my-secret-pw \
  -e MYSQL_USER=my-user \
  -e MYSQL_USER_PASSWORD=my-password \
  -e MYSQL_DATABASE=wordpress -d mysql:latest</pre></div>
<p>For my case, I&rsquo;m importing my MySQL dump from the old WordPress setup to the MySQL container.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker exec -i wp_mysql mysql -umy-user -pmy-password wordpress &lt; dump.sql</pre></div>
<p><strong>4. Containerize the Old WordPress Setup</strong></p>

<p>I&rsquo;m not using WordPress official image since this is an existing blog, not a new one. So, I re-arrange my WordPress directory structure before containerizing it. Here is the structure.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">wordpress_root
| src (for wp-content, wp-include, and the entire WordPress files)
| Dockerfile</pre></div>
<p>This is my Dockerfile. I&rsquo;m using PHP7 Apache as a base image.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">FROM php:7-apache

MAINTAINER Asep Bagja Priandana &lt;asep@asep.co&gt;

RUN a2enmod rewrite expires

# install the PHP extensions we need
RUN apt-get update &amp;&amp; apt-get install -y libpng12-dev libjpeg-dev &amp;&amp; rm -rf /var/lib/apt/lists/* \
    &amp;&amp; docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr \
    &amp;&amp; docker-php-ext-install gd mysqli opcache

# set recommended PHP.ini settings
# see https://secure.php.net/manual/en/opcache.installation.php
RUN { \
        echo &#39;opcache.memory_consumption=128&#39;; \
        echo &#39;opcache.interned_strings_buffer=8&#39;; \
        echo &#39;opcache.max_accelerated_files=4000&#39;; \
        echo &#39;opcache.revalidate_freq=60&#39;; \
        echo &#39;opcache.fast_shutdown=1&#39;; \
        echo &#39;opcache.enable_cli=1&#39;; \
} &gt; /usr/local/etc/php/conf.d/opcache-recommended.ini

COPY src/ /var/www/html/</pre></div>
<p>Then modify the existing <code>wp-config.php</code>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">// Don&#39;t hardcode your DB setting. Instead use environment variable.
/** The name of the database for WordPress */
define(&#39;DB_NAME&#39;, getenv(&#39;WORDPRESS_DB_NAME&#39;));

/** MySQL database username */
define(&#39;DB_USER&#39;, getenv(&#39;WORDPRESS_DB_USER&#39;));

/** MySQL database password */
define(&#39;DB_PASSWORD&#39;, getenv(&#39;WORDPRESS_DB_PASSWORD&#39;));

/** MySQL hostname */
define(&#39;DB_HOST&#39;, getenv(&#39;WORDPRESS_DB_HOST&#39;));

// Add these 2 lines, because we are running the Apache behind Nginx proxy
// Otherwise you will get infinite redirect
if ($_SERVER[&#39;HTTP_X_FORWARDED_PROTO&#39;] == &#39;https&#39;)
  $_SERVER[&#39;HTTPS&#39;]=&#39;on&#39;;

if (isset($_SERVER[&#39;HTTP_X_FORWARDED_HOST&#39;])) {
  $_SERVER[&#39;HTTP_HOST&#39;] = $_SERVER[&#39;HTTP_X_FORWARDED_HOST&#39;];
}</pre></div>
<p>Now, you can build your custom WordPress image.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker build -t user/my_wordpress .</pre></div>
<p><strong>5. Run the WordPress Image</strong></p>

<p>Let&rsquo;s run the newly created image.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">/home/user/:$ docker run --name my_wordpress \
  --link wp_mysql:mysql \
  -e WORDPRESS_DB_USER=my-user \
  -e WORDPRESS_DB_PASSWORD=my-password \
  -e WORDPRESS_DB_NAME=wordpress \
  -e &#34;WORDPRESS_DB_HOST=172.17.0.3&#34; \
  -e &#34;VIRTUAL_HOST=yourdomain.com&#34; \
  -e &#34;LETSENCRYPT_HOST=yourdomain.com,www.yourdomain.com&#34; \
  -e &#34;LETSENCRYPT_EMAIL=your@youremail.com&#34; -d user/my_wordpress</pre></div>
<p>Be careful, WORDPRESS_DB_HOST is your MySQL container&rsquo;s IP address.</p>

<p><strong>6. Pointing your domain to the host</strong></p>

<p>Now you can open your DNS manager and point the A record to your host IP and make www CNAME record with @ value. After the DNS propagation has completed and everything is correctly configured, you can access your website and see the little green lock icon on your browser.</p>

<p><strong>7. The last is configuring the URL inside your wp-admin</strong></p>

<p>Login to your WordPress dashboard then goes to Settings &gt; General. Replace the http with https.</p>

<p><img src="wordpress.png" alt="wordpress" /></p>

<p>Voila, now your WordPress site has ben secured and Google will love it.</p>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    © 2016 · Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
  </section>
</footer>

    </main>

    

  </body>

</html>
